[2025-06-30T13:51:21.950+0000] {taskinstance.py:1956} INFO - Dependencies all met for dep_context=non-requeueable deps ti=<TaskInstance: dim_card_etl.etl_cards_task manual__2025-06-30T13:51:18.484854+00:00 [queued]>
[2025-06-30T13:51:21.980+0000] {taskinstance.py:1956} INFO - Dependencies all met for dep_context=requeueable deps ti=<TaskInstance: dim_card_etl.etl_cards_task manual__2025-06-30T13:51:18.484854+00:00 [queued]>
[2025-06-30T13:51:21.981+0000] {taskinstance.py:2170} INFO - Starting attempt 1 of 2
[2025-06-30T13:51:22.021+0000] {taskinstance.py:2191} INFO - Executing <Task(PythonOperator): etl_cards_task> on 2025-06-30 13:51:18.484854+00:00
[2025-06-30T13:51:22.041+0000] {standard_task_runner.py:60} INFO - Started process 13676 to run task
[2025-06-30T13:51:22.050+0000] {standard_task_runner.py:87} INFO - Running: ['***', 'tasks', 'run', 'dim_card_etl', 'etl_cards_task', 'manual__2025-06-30T13:51:18.484854+00:00', '--job-id', '96', '--raw', '--subdir', 'DAGS_FOLDER/etl_dim_card_dag.py', '--cfg-path', '/tmp/tmpwn255y81']
[2025-06-30T13:51:22.060+0000] {standard_task_runner.py:88} INFO - Job 96: Subtask etl_cards_task
[2025-06-30T13:51:22.206+0000] {task_command.py:423} INFO - Running <TaskInstance: dim_card_etl.etl_cards_task manual__2025-06-30T13:51:18.484854+00:00 [running]> on host 65da94c758f2
[2025-06-30T13:51:23.229+0000] {taskinstance.py:2480} INFO - Exporting env vars: AIRFLOW_CTX_DAG_OWNER='jimmy' AIRFLOW_CTX_DAG_ID='dim_card_etl' AIRFLOW_CTX_TASK_ID='etl_cards_task' AIRFLOW_CTX_EXECUTION_DATE='2025-06-30T13:51:18.484854+00:00' AIRFLOW_CTX_TRY_NUMBER='1' AIRFLOW_CTX_DAG_RUN_ID='manual__2025-06-30T13:51:18.484854+00:00'
[2025-06-30T13:51:23.233+0000] {etl_dim_card_dag.py:23} INFO - Starting ETL for cards
[2025-06-30T13:51:23.311+0000] {extract_data.py:25} INFO - ✅ Extracted CARDS_data.csv with 6146 records
[2025-06-30T13:51:23.312+0000] {transform_dim_card.py:23} INFO - Starting transformation of CARDS data.
[2025-06-30T13:51:23.407+0000] {transform_dim_card.py:45} INFO - ✅finished transformation of CARDS data.
[2025-06-30T13:51:23.443+0000] {load_data.py:34} INFO - Successfully created database connection engine.
[2025-06-30T13:51:23.719+0000] {load_data.py:79} INFO - Table 'financial.dim_card' has data.
[2025-06-30T13:51:23.738+0000] {load_data.py:81} INFO - ✅ Table 'financial.dim_card' loaded successfully.
[2025-06-30T13:51:23.906+0000] {load_data.py:94} ERROR - ❌Error loading data into table 'dim_card': (pyodbc.IntegrityError) ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Violation of PRIMARY KEY constraint 'PK__dim_card__BDF201DDDF2D9056'. Cannot insert duplicate key in object 'financial.dim_card'. The duplicate key value is (4524). (2627) (SQLExecDirectW)")
[SQL: INSERT INTO financial.dim_card (card_id, card_brand, card_type, expires, has_chip, num_cards_issued, credit_limit, account_open_date, year_pin_last_changed, card_on_dark_web) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (('4524', 'Visa', 'Debit', datetime.datetime(2022, 12, 1, 0, 0), 'Yes', 2, 24295, datetime.datetime(2002, 9, 1, 0, 0), 2008, 'No'), ('2731', 'Visa', 'Debit', datetime.datetime(2020, 12, 1, 0, 0), 'Yes', 2, 21968, datetime.datetime(2014, 4, 1, 0, 0), 2014, 'No'), ('3701', 'Visa', 'Debit', datetime.datetime(2024, 2, 1, 0, 0), 'Yes', 2, 46414, datetime.datetime(2003, 7, 1, 0, 0), 2004, 'No'), ('42', 'Visa', 'Credit', datetime.datetime(2024, 8, 1, 0, 0), 'No', 1, 12400, datetime.datetime(2003, 1, 1, 0, 0), 2012, 'No'), ('4659', 'Mastercard', 'Debit (Prepaid)', datetime.datetime(2009, 3, 1, 0, 0), 'Yes', 1, 28, datetime.datetime(2008, 9, 1, 0, 0), 2009, 'No'), ('4537', 'Visa', 'Credit', datetime.datetime(2003, 9, 1, 0, 0), 'Yes', 1, 27500, datetime.datetime(2003, 9, 1, 0, 0), 2012, 'No'), ('1278', 'Visa', 'Debit', datetime.datetime(2022, 7, 1, 0, 0), 'Yes', 2, 28508, datetime.datetime(2011, 2, 1, 0, 0), 2011, 'No'), ('3687', 'Mastercard', 'Debit', datetime.datetime(2022, 6, 1, 0, 0), 'Yes', 2, 9022, datetime.datetime(2003, 7, 1, 0, 0), 2015, 'No')  ... displaying 10 of 1000 total bound parameter sets ...  ('1016', 'Mastercard', 'Debit', datetime.datetime(2020, 2, 1, 0, 0), 'Yes', 2, 30074, datetime.datetime(2003, 2, 1, 0, 0), 2006, 'No'), ('1017', 'Mastercard', 'Debit', datetime.datetime(2016, 5, 1, 0, 0), 'Yes', 1, 7589, datetime.datetime(2003, 2, 1, 0, 0), 2011, 'No'))]
(Background on this error at: https://sqlalche.me/e/14/gkpj)
[2025-06-30T13:51:23.908+0000] {taskinstance.py:2698} ERROR - Task failed with exception
Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 1890, in _execute_context
    self.dialect.do_executemany(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/dialects/mssql/pyodbc.py", line 649, in do_executemany
    super(MSDialect_pyodbc, self).do_executemany(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/default.py", line 733, in do_executemany
    cursor.executemany(statement, parameters)
pyodbc.IntegrityError: ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Violation of PRIMARY KEY constraint 'PK__dim_card__BDF201DDDF2D9056'. Cannot insert duplicate key in object 'financial.dim_card'. The duplicate key value is (4524). (2627) (SQLExecDirectW)")

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/models/taskinstance.py", line 433, in _execute_task
    result = execute_callable(context=context, **execute_callable_kwargs)
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/operators/python.py", line 199, in execute
    return_value = self.execute_callable()
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/operators/python.py", line 216, in execute_callable
    return self.python_callable(*self.op_args, **self.op_kwargs)
  File "/opt/airflow/dags/etl_dim_card_dag.py", line 27, in my_etl_task
    load.load_dataframe_to_sql(cards_df_clean,'dim_card',engine,'financial')
  File "/opt/airflow/ETL/load_data.py", line 84, in load_dataframe_to_sql
    df.to_sql(
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/core/generic.py", line 2878, in to_sql
    return sql.to_sql(
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 769, in to_sql
    return pandas_sql.to_sql(
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 1920, in to_sql
    total_inserted = sql_engine.insert_records(
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 1470, in insert_records
    raise err
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 1461, in insert_records
    return table.insert(chunksize=chunksize, method=method)
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 1023, in insert
    num_inserted = exec_insert(conn, keys, chunk_iter)
  File "/home/airflow/.local/lib/python3.8/site-packages/pandas/io/sql.py", line 929, in _execute_insert
    result = conn.execute(self.table.insert(), data)
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 1385, in execute
    return meth(self, multiparams, params, _EMPTY_EXECUTION_OPTS)
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/sql/elements.py", line 334, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 1577, in _execute_clauseelement
    ret = self._execute_context(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 1953, in _execute_context
    self._handle_dbapi_exception(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 2134, in _handle_dbapi_exception
    util.raise_(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/util/compat.py", line 211, in raise_
    raise exception
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/base.py", line 1890, in _execute_context
    self.dialect.do_executemany(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/dialects/mssql/pyodbc.py", line 649, in do_executemany
    super(MSDialect_pyodbc, self).do_executemany(
  File "/home/airflow/.local/lib/python3.8/site-packages/sqlalchemy/engine/default.py", line 733, in do_executemany
    cursor.executemany(statement, parameters)
sqlalchemy.exc.IntegrityError: (pyodbc.IntegrityError) ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Violation of PRIMARY KEY constraint 'PK__dim_card__BDF201DDDF2D9056'. Cannot insert duplicate key in object 'financial.dim_card'. The duplicate key value is (4524). (2627) (SQLExecDirectW)")
[SQL: INSERT INTO financial.dim_card (card_id, card_brand, card_type, expires, has_chip, num_cards_issued, credit_limit, account_open_date, year_pin_last_changed, card_on_dark_web) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (('4524', 'Visa', 'Debit', datetime.datetime(2022, 12, 1, 0, 0), 'Yes', 2, 24295, datetime.datetime(2002, 9, 1, 0, 0), 2008, 'No'), ('2731', 'Visa', 'Debit', datetime.datetime(2020, 12, 1, 0, 0), 'Yes', 2, 21968, datetime.datetime(2014, 4, 1, 0, 0), 2014, 'No'), ('3701', 'Visa', 'Debit', datetime.datetime(2024, 2, 1, 0, 0), 'Yes', 2, 46414, datetime.datetime(2003, 7, 1, 0, 0), 2004, 'No'), ('42', 'Visa', 'Credit', datetime.datetime(2024, 8, 1, 0, 0), 'No', 1, 12400, datetime.datetime(2003, 1, 1, 0, 0), 2012, 'No'), ('4659', 'Mastercard', 'Debit (Prepaid)', datetime.datetime(2009, 3, 1, 0, 0), 'Yes', 1, 28, datetime.datetime(2008, 9, 1, 0, 0), 2009, 'No'), ('4537', 'Visa', 'Credit', datetime.datetime(2003, 9, 1, 0, 0), 'Yes', 1, 27500, datetime.datetime(2003, 9, 1, 0, 0), 2012, 'No'), ('1278', 'Visa', 'Debit', datetime.datetime(2022, 7, 1, 0, 0), 'Yes', 2, 28508, datetime.datetime(2011, 2, 1, 0, 0), 2011, 'No'), ('3687', 'Mastercard', 'Debit', datetime.datetime(2022, 6, 1, 0, 0), 'Yes', 2, 9022, datetime.datetime(2003, 7, 1, 0, 0), 2015, 'No')  ... displaying 10 of 1000 total bound parameter sets ...  ('1016', 'Mastercard', 'Debit', datetime.datetime(2020, 2, 1, 0, 0), 'Yes', 2, 30074, datetime.datetime(2003, 2, 1, 0, 0), 2006, 'No'), ('1017', 'Mastercard', 'Debit', datetime.datetime(2016, 5, 1, 0, 0), 'Yes', 1, 7589, datetime.datetime(2003, 2, 1, 0, 0), 2011, 'No'))]
(Background on this error at: https://sqlalche.me/e/14/gkpj)
[2025-06-30T13:51:23.991+0000] {taskinstance.py:1138} INFO - Marking task as UP_FOR_RETRY. dag_id=dim_card_etl, task_id=etl_cards_task, execution_date=20250630T135118, start_date=20250630T135121, end_date=20250630T135123
[2025-06-30T13:51:24.027+0000] {standard_task_runner.py:107} ERROR - Failed to execute job 96 for task etl_cards_task ((pyodbc.IntegrityError) ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Violation of PRIMARY KEY constraint 'PK__dim_card__BDF201DDDF2D9056'. Cannot insert duplicate key in object 'financial.dim_card'. The duplicate key value is (4524). (2627) (SQLExecDirectW)")
[SQL: INSERT INTO financial.dim_card (card_id, card_brand, card_type, expires, has_chip, num_cards_issued, credit_limit, account_open_date, year_pin_last_changed, card_on_dark_web) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: (('4524', 'Visa', 'Debit', datetime.datetime(2022, 12, 1, 0, 0), 'Yes', 2, 24295, datetime.datetime(2002, 9, 1, 0, 0), 2008, 'No'), ('2731', 'Visa', 'Debit', datetime.datetime(2020, 12, 1, 0, 0), 'Yes', 2, 21968, datetime.datetime(2014, 4, 1, 0, 0), 2014, 'No'), ('3701', 'Visa', 'Debit', datetime.datetime(2024, 2, 1, 0, 0), 'Yes', 2, 46414, datetime.datetime(2003, 7, 1, 0, 0), 2004, 'No'), ('42', 'Visa', 'Credit', datetime.datetime(2024, 8, 1, 0, 0), 'No', 1, 12400, datetime.datetime(2003, 1, 1, 0, 0), 2012, 'No'), ('4659', 'Mastercard', 'Debit (Prepaid)', datetime.datetime(2009, 3, 1, 0, 0), 'Yes', 1, 28, datetime.datetime(2008, 9, 1, 0, 0), 2009, 'No'), ('4537', 'Visa', 'Credit', datetime.datetime(2003, 9, 1, 0, 0), 'Yes', 1, 27500, datetime.datetime(2003, 9, 1, 0, 0), 2012, 'No'), ('1278', 'Visa', 'Debit', datetime.datetime(2022, 7, 1, 0, 0), 'Yes', 2, 28508, datetime.datetime(2011, 2, 1, 0, 0), 2011, 'No'), ('3687', 'Mastercard', 'Debit', datetime.datetime(2022, 6, 1, 0, 0), 'Yes', 2, 9022, datetime.datetime(2003, 7, 1, 0, 0), 2015, 'No')  ... displaying 10 of 1000 total bound parameter sets ...  ('1016', 'Mastercard', 'Debit', datetime.datetime(2020, 2, 1, 0, 0), 'Yes', 2, 30074, datetime.datetime(2003, 2, 1, 0, 0), 2006, 'No'), ('1017', 'Mastercard', 'Debit', datetime.datetime(2016, 5, 1, 0, 0), 'Yes', 1, 7589, datetime.datetime(2003, 2, 1, 0, 0), 2011, 'No'))]
(Background on this error at: https://sqlalche.me/e/14/gkpj); 13676)
[2025-06-30T13:51:24.080+0000] {local_task_job_runner.py:234} INFO - Task exited with return code 1
[2025-06-30T13:51:24.127+0000] {taskinstance.py:3280} INFO - 0 downstream tasks scheduled from follow-on schedule check
